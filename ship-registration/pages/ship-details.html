<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تفاصيل السفينة - نظام تسجيل السفن</title>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* ===== نفس تنسيقات صفحة تفاصيل الطلب مع إضافات خاصة بالسفينة ===== */
        :root {
            --primary: #1e4b7a;
            --primary-dark: #0f2c4a;
            --primary-light: #2c7be5;
            --secondary: #8b7355;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --white: #ffffff;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans Arabic', sans-serif;
            background: linear-gradient(135deg, #f1f5f9 0%, #e6eef5 100%);
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ===== شريط التنقل ===== */
        .navbar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 16px 32px;
            border-radius: var(--radius-lg);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .navbar-brand i {
            font-size: 1.8rem;
        }

        .navbar-brand h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-light {
            background: white;
            color: var(--primary);
        }

        .btn-light:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #1e7e34);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #e0a800);
            color: white;
        }

        /* ===== بطاقة رأس السفينة ===== */
        .ship-header {
            background: white;
            border-radius: var(--radius-lg);
            padding: 30px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ship-info {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .ship-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
        }

        .ship-details h2 {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .ship-meta {
            display: flex;
            gap: 20px;
            color: #64748b;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
        }

        .status-active {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
            border: 1px solid rgba(40, 167, 69, 0.2);
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }

        .status-expired {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
            border: 1px solid rgba(220, 53, 69, 0.2);
        }

        /* ===== بطاقات المعلومات ===== */
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .detail-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 25px;
            box-shadow: var(--shadow-sm);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .card-header h3 {
            color: var(--primary);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-row {
            display: flex;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8fafc;
            border-radius: var(--radius-sm);
        }

        .info-label {
            width: 130px;
            font-weight: 600;
            color: var(--dark);
        }

        .info-value {
            flex: 1;
            color: #64748b;
        }

        /* ===== بطاقة الشهادات ===== */
        .certificates-timeline {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .certificate-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: var(--radius-md);
            border-right: 4px solid transparent;
        }

        .certificate-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .certificate-content {
            flex: 1;
        }

        .certificate-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .certificate-number {
            font-weight: 700;
            color: var(--primary);
        }

        .certificate-date {
            font-size: 0.85rem;
            color: #64748b;
        }

        .certificate-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* ===== جدول سجل المعاملات ===== */
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .transactions-table th {
            background: linear-gradient(135deg, rgba(30, 75, 122, 0.05), rgba(15, 44, 74, 0.05));
            color: var(--primary);
            padding: 15px;
            text-align: right;
            font-weight: 700;
        }

        .transactions-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .transaction-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* ===== التنبيهات ===== */
        .alert-card {
            background: rgba(255, 193, 7, 0.1);
            border-right: 4px solid var(--warning);
            padding: 20px;
            border-radius: var(--radius-md);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-icon {
            font-size: 1.5rem;
            color: var(--warning);
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 700;
            color: #856404;
            margin-bottom: 5px;
        }

        /* ===== منطقة التحميل ===== */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--primary);
        }

        .loading i {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .details-grid {
                grid-template-columns: 1fr;
            }
            
            .ship-header {
                flex-direction: column;
                gap: 20px;
            }
            
            .ship-info {
                flex-direction: column;
                text-align: center;
            }
            
            .ship-meta {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- شريط التنقل -->
        <nav class="navbar">
            <div class="navbar-brand">
                <i class="fas fa-ship"></i>
                <h1>نظام تسجيل السفن</h1>
            </div>
            <div>
                <button class="btn btn-light" onclick="goBack()">
                    <i class="fas fa-arrow-right"></i> العودة
                </button>
            </div>
        </nav>

        <!-- منطقة التحميل -->
        <div id="loadingIndicator" class="loading">
            <i class="fas fa-circle-notch fa-spin"></i>
            <h3>جاري تحميل بيانات السفينة...</h3>
        </div>

        <!-- محتوى الصفحة (مخفي في البداية) -->
        <div id="shipContent" style="display: none;">
            <!-- رأس السفينة -->
            <div class="ship-header">
                <div class="ship-info">
                    <div class="ship-icon">
                        <i class="fas fa-ship"></i>
                    </div>
                    <div>
                        <h2 id="shipNameAr">---</h2>
                        <p id="shipNameEn" style="color: #64748b;">---</p>
                        <div class="ship-meta">
                            <span><i class="fas fa-hashtag"></i> <span id="registrationNumber">---</span></span>
                            <span><i class="fas fa-flag"></i> <span id="flagState">---</span></span>
                            <span><i class="fas fa-calendar"></i> <span id="registrationDate">---</span></span>
                        </div>
                    </div>
                </div>
                <div>
                    <span class="status-badge" id="statusBadge">---</span>
                </div>
            </div>

            <!-- تنبيه انتهاء الشهادة -->
            <div id="expiryAlert" class="alert-card" style="display: none;">
                <div class="alert-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="alert-content">
                    <div class="alert-title">تنبيه: الشهادة على وشك الانتهاء</div>
                    <p id="expiryAlertMessage">شهادة تسجيل السفينة ستنتهي في ---</p>
                </div>
                <button class="btn btn-warning" onclick="renewShip()">
                    <i class="fas fa-sync-alt"></i> تجديد الآن
                </button>
            </div>

            <!-- شبكة المعلومات -->
            <div class="details-grid">
                <!-- المعلومات الأساسية -->
                <div class="detail-card">
                    <div class="card-header">
                        <h3><i class="fas fa-info-circle"></i> المعلومات الأساسية</h3>
                    </div>
                    <div id="basicInfo">
                        <!-- سيتم ملؤها ديناميكياً -->
                    </div>
                </div>

                <!-- المعلومات الفنية -->
                <div class="detail-card">
                    <div class="card-header">
                        <h3><i class="fas fa-cogs"></i> المواصفات الفنية</h3>
                    </div>
                    <div id="technicalInfo">
                        <!-- سيتم ملؤها ديناميكياً -->
                    </div>
                </div>

                <!-- معلومات المالك -->
                <div class="detail-card">
                    <div class="card-header">
                        <h3><i class="fas fa-user"></i> معلومات المالك</h3>
                    </div>
                    <div id="ownerInfo">
                        <!-- سيتم ملؤها ديناميكياً -->
                    </div>
                </div>

                <!-- معلومات التسجيل -->
                <div class="detail-card">
                    <div class="card-header">
                        <h3><i class="fas fa-file-contract"></i> معلومات التسجيل</h3>
                    </div>
                    <div id="registrationInfo">
                        <!-- سيتم ملؤها ديناميكياً -->
                    </div>
                </div>
            </div>

            <!-- قسم المحركات (إذا كانت السفينة بمحركات متعددة) -->
            <div class="detail-card" style="margin-bottom: 30px;" id="enginesSection">
                <div class="card-header">
                    <h3><i class="fas fa-engine"></i> تفاصيل المحركات</h3>
                </div>
                <div id="enginesInfo" style="overflow-x: auto;">
                    <!-- سيتم ملؤها ديناميكياً -->
                </div>
            </div>

            <!-- قسم الشهادات -->
            <div class="detail-card" style="margin-bottom: 30px;">
                <div class="card-header">
                    <h3><i class="fas fa-certificate"></i> الشهادات والتراخيص</h3>
                    <button class="btn btn-outline btn-sm" onclick="printCertificate()">
                        <i class="fas fa-print"></i> طباعة الشهادة
                    </button>
                </div>
                <div id="certificatesList" class="certificates-timeline">
                    <!-- سيتم ملؤها ديناميكياً -->
                </div>
            </div>

            <!-- سجل المعاملات -->
            <div class="detail-card" style="margin-bottom: 30px;">
                <div class="card-header">
                    <h3><i class="fas fa-history"></i> سجل المعاملات</h3>
                </div>
                <div style="overflow-x: auto;">
                    <table class="transactions-table" id="transactionsTable">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>نوع المعاملة</th>
                                <th>رقم المعاملة</th>
                                <th>الحالة</th>
                                <th>الموظف المسؤول</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody">
                            <tr>
                                <td colspan="6" style="text-align: center;">لا توجد معاملات سابقة</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- شريط الإجراءات -->
            <div class="action-bar" style="background: white; border-radius: var(--radius-lg); padding: 20px 30px; box-shadow: var(--shadow-md); display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="printShipDetails()">
                    <i class="fas fa-print"></i> طباعة التفاصيل
                </button>
                <button class="btn btn-outline" onclick="viewApplications()">
                    <i class="fas fa-file-alt"></i> عرض الطلبات
                </button>
                <button class="btn btn-outline" onclick="viewHistory()">
                    <i class="fas fa-chart-line"></i> السجل الكامل
                </button>
                <button class="btn btn-success" onclick="renewShip()" id="renewBtn">
                    <i class="fas fa-sync-alt"></i> تجديد التسجيل
                </button>
                <button class="btn btn-warning" onclick="reportIssue()">
                    <i class="fas fa-exclamation-triangle"></i> الإبلاغ عن مشكلة
                </button>
            </div>
        </div>
    </div>

    <script>
        // ================================================
        // تهيئة Supabase
        // ================================================
        const SUPABASE_URL = 'hhttps://jswzallmawmjypimixbb.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_LRAvXJd5qHXdHo7jWRF49Q_ruw8kTmt';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: true
            }
        });

        // ================================================
        // المتغيرات العامة
        // ================================================
        let currentUser = null;
        let currentShip = null;
        let shipId = null;

        // ================================================
        // تحميل الصفحة
        // ================================================
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuth();
            
            // الحصول على معرف السفينة من URL
            const urlParams = new URLSearchParams(window.location.search);
            shipId = urlParams.get('id');
            
            if (!shipId) {
                alert('معرف السفينة غير موجود');
                goBack();
                return;
            }
            
            await loadShipDetails();
        });

        async function checkAuth() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error || !session) {
                    window.location.href = 'index.html';
                    return;
                }
                
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();
                
                if (userError || !user) {
                    window.location.href = 'index.html';
                    return;
                }
                
                currentUser = user;
                
            } catch (error) {
                console.error('خطأ في التحقق من الجلسة:', error);
                window.location.href = 'index.html';
            }
        }

        async function loadShipDetails() {
            try {
                const { data, error } = await supabase
                    .from('ships')
                    .select(`
                        *,
                        owner:owner_id (
                            id,
                            full_name,
                            email,
                            phone,
                            national_id,
                            address,
                            city,
                            governorate,
                            commercial_registration,
                            tax_number
                        ),
                        certificates (
                            id,
                            certificate_number,
                            certificate_type,
                            issue_date,
                            expiry_date,
                            issued_by,
                            issuing_authority,
                            status,
                            created_at
                        ),
                        applications (
                            id,
                            application_number,
                            application_type,
                            status,
                            submission_date,
                            approval_date
                        ),
                        engines:ship_engines (
                            id,
                            engine_number,
                            engine_type,
                            engine_manufacturer,
                            engine_model,
                            engine_power,
                            engine_power_unit,
                            engine_year,
                            cylinder_count
                        )
                    `)
                    .eq('id', shipId)
                    .single();
                
                if (error) throw error;
                
                currentShip = data;
                
                // إخفاء التحميل وإظهار المحتوى
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('shipContent').style.display = 'block';
                
                // تحديث واجهة المستخدم
                updateShipUI();
                
            } catch (error) {
                console.error('خطأ في تحميل بيانات السفينة:', error);
                document.getElementById('loadingIndicator').innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
                    <h3>حدث خطأ في تحميل بيانات السفينة</h3>
                    <p>${error.message}</p>
                    <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 20px;">
                        <i class="fas fa-redo"></i> إعادة المحاولة
                    </button>
                `;
            }
        }

        function updateShipUI() {
            // تحديث المعلومات الأساسية
            document.getElementById('shipNameAr').textContent = currentShip.ship_name_ar || '---';
            document.getElementById('shipNameEn').textContent = currentShip.ship_name_en || '---';
            document.getElementById('registrationNumber').textContent = currentShip.registration_number || '---';
            document.getElementById('flagState').textContent = currentShip.flag_state || '---';
            document.getElementById('registrationDate').textContent = formatDate(currentShip.registration_date);
            
            // تحديث حالة السفينة
            const statusBadge = document.getElementById('statusBadge');
            const status = currentShip.status || 'pending';
            statusBadge.textContent = getShipStatusText(status);
            statusBadge.className = `status-badge status-${status}`;
            
            // تحديث المعلومات الأساسية
            updateBasicInfo();
            
            // تحديث المعلومات الفنية
            updateTechnicalInfo();
            
            // تحديث معلومات المالك
            updateOwnerInfo();
            
            // تحديث معلومات التسجيل
            updateRegistrationInfo();
            
            // تحديث معلومات المحركات
            updateEnginesInfo();
            
            // تحديث الشهادات
            updateCertificates();
            
            // تحديث سجل المعاملات
            updateTransactions();
            
            // التحقق من الشهادات المنتهية
            checkExpiringCertificates();
            
            // تحديث شريط الإجراءات حسب الصلاحيات
            updateActionButtons();
        }

        function updateBasicInfo() {
            let html = `
                <div class="info-row">
                    <span class="info-label">نوع السفينة:</span>
                    <span class="info-value">${currentShip.ship_type || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">فئة السفينة:</span>
                    <span class="info-value">${currentShip.ship_category || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">رقم IMO:</span>
                    <span class="info-value">${currentShip.imo_number || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">نداء النداء:</span>
                    <span class="info-value">${currentShip.call_sign || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">MMSI:</span>
                    <span class="info-value">${currentShip.mmsi || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ميناء التسجيل:</span>
                    <span class="info-value">${currentShip.port_of_registry || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ميناء المنشأ:</span>
                    <span class="info-value">${currentShip.port_of_origin || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">علم السفينة:</span>
                    <span class="info-value">${currentShip.flag_state || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">الجنسية:</span>
                    <span class="info-value">${currentShip.nationality || '---'}</span>
                </div>
            `;
            
            document.getElementById('basicInfo').innerHTML = html;
        }

        function updateTechnicalInfo() {
            let html = `
                <div class="info-row">
                    <span class="info-label">الحمولة الإجمالية:</span>
                    <span class="info-value">${currentShip.gross_tonnage || '---'} طن</span>
                </div>
                <div class="info-row">
                    <span class="info-label">الحمولة الصافية:</span>
                    <span class="info-value">${currentShip.net_tonnage || '---'} طن</span>
                </div>
                <div class="info-row">
                    <span class="info-label">الوزن الساكن:</span>
                    <span class="info-value">${currentShip.deadweight || '---'} طن</span>
                </div>
                <div class="info-row">
                    <span class="info-label">الطول الكلي:</span>
                    <span class="info-value">${currentShip.length_overall || currentShip.length || '---'} م</span>
                </div>
                <div class="info-row">
                    <span class="info-label">العرض:</span>
                    <span class="info-value">${currentShip.beam || currentShip.width || '---'} م</span>
                </div>
                <div class="info-row">
                    <span class="info-label">العمق:</span>
                    <span class="info-value">${currentShip.depth || '---'} م</span>
                </div>
                <div class="info-row">
                    <span class="info-label">الغاطس:</span>
                    <span class="info-value">${currentShip.draft || '---'} م</span>
                </div>
                <div class="info-row">
                    <span class="info-label">سرعة السفينة:</span>
                    <span class="info-value">${currentShip.speed || '---'} عقدة</span>
                </div>
                <div class="info-row">
                    <span class="info-label">سعة الحاويات:</span>
                    <span class="info-value">${currentShip.container_capacity || '---'} TEU</span>
                </div>
                <div class="info-row">
                    <span class="info-label">سعة الركاب:</span>
                    <span class="info-value">${currentShip.passenger_capacity || '---'} راكب</span>
                </div>
                <div class="info-row">
                    <span class="info-label">عدد أفراد الطاقم:</span>
                    <span class="info-value">${currentShip.crew_capacity || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">سنة الصنع:</span>
                    <span class="info-value">${currentShip.year_built || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">اسم الشركة الصانعة:</span>
                    <span class="info-value">${currentShip.builder_name || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">بلد الصنع:</span>
                    <span class="info-value">${currentShip.building_country || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">حوض بناء السفن:</span>
                    <span class="info-value">${currentShip.shipyard || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">رقم الهيكل:</span>
                    <span class="info-value">${currentShip.hull_number || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">مادة الهيكل:</span>
                    <span class="info-value">${currentShip.hull_material || '---'}</span>
                </div>
            `;
            
            document.getElementById('technicalInfo').innerHTML = html;
        }

        function updateOwnerInfo() {
            const owner = currentShip.owner;
            if (!owner) {
                document.getElementById('ownerInfo').innerHTML = '<p style="color: #64748b;">لا توجد معلومات</p>';
                return;
            }
            
            let html = `
                <div class="info-row">
                    <span class="info-label">اسم المالك:</span>
                    <span class="info-value">${owner.full_name || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">البريد الإلكتروني:</span>
                    <span class="info-value">${owner.email || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">رقم الهاتف:</span>
                    <span class="info-value">${owner.phone || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">رقم الهوية:</span>
                    <span class="info-value">${owner.national_id || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">العنوان:</span>
                    <span class="info-value">${owner.address || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">المدينة:</span>
                    <span class="info-value">${owner.city || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">المحافظة:</span>
                    <span class="info-value">${owner.governorate || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">السجل التجاري:</span>
                    <span class="info-value">${owner.commercial_registration || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">الرقم الضريبي:</span>
                    <span class="info-value">${owner.tax_number || '---'}</span>
                </div>
            `;
            
            document.getElementById('ownerInfo').innerHTML = html;
        }

        function updateRegistrationInfo() {
            let html = `
                <div class="info-row">
                    <span class="info-label">حالة التسجيل:</span>
                    <span class="info-value">${getShipStatusText(currentShip.status)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">تاريخ التسجيل:</span>
                    <span class="info-value">${formatDate(currentShip.registration_date)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">تاريخ الانتهاء:</span>
                    <span class="info-value">${formatDate(currentShip.expiry_date)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ميناء التسجيل:</span>
                    <span class="info-value">${currentShip.port_of_registry || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">سلطة التسجيل:</span>
                    <span class="info-value">${currentShip.registration_authority || 'الهيئة العامة للشئون البحرية'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">المكتب المسجل فيه:</span>
                    <span class="info-value">${currentShip.registration_office || '---'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">آخر تجديد:</span>
                    <span class="info-value">${formatDate(currentShip.last_renewal_date)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">آخر تحديث:</span>
                    <span class="info-value">${formatDate(currentShip.updated_at)}</span>
                </div>
            `;
            
            document.getElementById('registrationInfo').innerHTML = html;
        }

        function updateEnginesInfo() {
            const engines = currentShip.engines || [];
            const enginesSection = document.getElementById('enginesSection');
            
            if (engines.length === 0) {
                enginesSection.style.display = 'none';
                return;
            }
            
            enginesSection.style.display = 'block';
            
            let html = `
                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th>رقم المحرك</th>
                            <th>النوع</th>
                            <th>الصانع</th>
                            <th>الموديل</th>
                            <th>القوة</th>
                            <th>سنة الصنع</th>
                            <th>عدد الأسطوانات</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            engines.forEach(engine => {
                html += `
                    <tr>
                        <td>${engine.engine_number || '---'}</td>
                        <td>${engine.engine_type || '---'}</td>
                        <td>${engine.engine_manufacturer || '---'}</td>
                        <td>${engine.engine_model || '---'}</td>
                        <td>${engine.engine_power || '---'} ${engine.engine_power_unit || 'حصان'}</td>
                        <td>${engine.engine_year || '---'}</td>
                        <td>${engine.cylinder_count || '---'}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            document.getElementById('enginesInfo').innerHTML = html;
        }

        function updateCertificates() {
            const certificates = currentShip.certificates || [];
            const container = document.getElementById('certificatesList');
            
            if (certificates.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center;">لا توجد شهادات مسجلة</p>';
                return;
            }
            
            let html = '';
            certificates.sort((a, b) => new Date(b.issue_date) - new Date(a.issue_date));
            
            certificates.forEach(cert => {
                const isExpired = cert.expiry_date && new Date(cert.expiry_date) < new Date();
                const isExpiring = !isExpired && cert.expiry_date && 
                    (new Date(cert.expiry_date) - new Date()) / (1000 * 60 * 60 * 24) <= 30;
                
                let statusClass = 'status-active';
                let statusText = 'نشط';
                
                if (isExpired) {
                    statusClass = 'status-expired';
                    statusText = 'منتهي';
                } else if (isExpiring) {
                    statusClass = 'status-pending';
                    statusText = 'سينتهي قريباً';
                }
                
                const iconColor = isExpired ? '#dc3545' : isExpiring ? '#ffc107' : '#28a745';
                
                html += `
                    <div class="certificate-item">
                        <div class="certificate-icon" style="background: ${iconColor};">
                            <i class="fas fa-certificate"></i>
                        </div>
                        <div class="certificate-content">
                            <div class="certificate-header">
                                <span class="certificate-number">${cert.certificate_number || '---'}</span>
                                <span class="certificate-date">${formatDate(cert.issue_date)}</span>
                            </div>
                            <div style="margin-bottom: 8px;">${getCertificateTypeText(cert.certificate_type)}</div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="certificate-status ${statusClass}">${statusText}</span>
                                <span style="font-size: 0.85rem; color: #64748b;">
                                    ${cert.expiry_date ? `ينتهي في ${formatDate(cert.expiry_date)}` : ''}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateTransactions() {
            const applications = currentShip.applications || [];
            const tbody = document.getElementById('transactionsBody');
            
            if (applications.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">لا توجد معاملات سابقة</td></tr>';
                return;
            }
            
            let html = '';
            applications.sort((a, b) => new Date(b.submission_date) - new Date(a.submission_date));
            
            applications.forEach(app => {
                const typeClass = {
                    'new': 'status-active',
                    'renewal': 'status-pending',
                    'transfer': 'status-pending',
                    'amendment': 'status-pending',
                    'cancellation': 'status-expired'
                }[app.application_type] || 'status-pending';
                
                html += `
                    <tr>
                        <td>${formatDate(app.submission_date)}</td>
                        <td><span class="transaction-type ${typeClass}">${getApplicationTypeText(app.application_type)}</span></td>
                        <td>${app.application_number || '---'}</td>
                        <td><span class="status-badge status-${app.status}" style="padding: 4px 12px;">${getStatusText(app.status)}</span></td>
                        <td>---</td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="viewApplication('${app.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function checkExpiringCertificates() {
            const expiryAlert = document.getElementById('expiryAlert');
            const renewBtn = document.getElementById('renewBtn');
            
            if (!currentShip.expiry_date) {
                expiryAlert.style.display = 'none';
                return;
            }
            
            const expiryDate = new Date(currentShip.expiry_date);
            const today = new Date();
            const daysRemaining = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
            
            if (daysRemaining <= 30 && daysRemaining > 0) {
                expiryAlert.style.display = 'flex';
                document.getElementById('expiryAlertMessage').innerHTML = 
                    `شهادة تسجيل السفينة ستنتهي بعد ${daysRemaining} يوم`;
                renewBtn.style.display = 'inline-flex';
            } else if (daysRemaining <= 0) {
                expiryAlert.style.display = 'flex';
                document.getElementById('expiryAlertMessage').innerHTML = 
                    'شهادة تسجيل السفينة منتهية، يرجى تجديد التسجيل';
                renewBtn.style.display = 'inline-flex';
            } else {
                expiryAlert.style.display = 'none';
            }
        }

        function updateActionButtons() {
            const renewBtn = document.getElementById('renewBtn');
            
            // إخفاء زر التجديد للمستخدمين غير المالكين
            if (currentUser.role !== 'ship_owner' || currentUser.id !== currentShip.owner_id) {
                renewBtn.style.display = 'none';
            }
        }

        // ================================================
        // الإجراءات
        // ================================================
        async function renewShip() {
            if (!confirm('هل أنت متأكد من تجديد تسجيل هذه السفينة؟')) return;
            
            try {
                // إنشاء طلب تجديد
                const { data: application, error: appError } = await supabase
                    .from('applications')
                    .insert({
                        owner_id: currentShip.owner_id,
                        ship_id: currentShip.id,
                        application_type: 'renewal',
                        application_number: `REN-${new Date().getFullYear()}-${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}`,
                        branch: currentUser.branch || 'main',
                        status: 'pending',
                        submission_date: new Date().toISOString().split('T')[0],
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .select()
                    .single();
                
                if (appError) throw appError;
                
                alert('تم إنشاء طلب التجديد بنجاح');
                window.location.href = `application-details.html?id=${application.id}`;
                
            } catch (error) {
                console.error('خطأ في تجديد السفينة:', error);
                alert('فشل إنشاء طلب التجديد: ' + error.message);
            }
        }

        function printShipDetails() {
            window.print();
        }

        function printCertificate() {
            const activeCert = currentShip.certificates?.find(c => 
                c.status === 'active' && new Date(c.expiry_date) > new Date()
            );
            
            if (activeCert) {
                window.open(`print-certificate.html?cert=${activeCert.id}`, '_blank');
            } else {
                alert('لا توجد شهادة نشطة للطباعة');
            }
        }

        function viewApplications() {
            window.location.href = `ship-applications.html?ship=${shipId}`;
        }

        function viewHistory() {
            window.location.href = `ship-history.html?ship=${shipId}`;
        }

        function viewApplication(applicationId) {
            window.location.href = `application-details.html?id=${applicationId}`;
        }

        function reportIssue() {
            window.location.href = `report-issue.html?ship=${shipId}`;
        }

        function goBack() {
            window.history.back();
        }

        // ================================================
        // دوال مساعدة
        // ================================================
        function formatDate(date) {
            if (!date) return '---';
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getShipStatusText(status) {
            const statusMap = {
                'active': 'نشط',
                'pending': 'قيد المراجعة',
                'expired': 'منتهي',
                'suspended': 'موقوف',
                'deleted': 'محذوف'
            };
            return statusMap[status] || status;
        }

        function getStatusText(status) {
            const statusMap = {
                'draft': 'مسودة',
                'pending': 'قيد المراجعة',
                'reviewing': 'جاري المعالجة',
                'approved': 'مقبول',
                'rejected': 'مرفوض',
                'needs_action': 'يحتاج إجراء',
                'completed': 'مكتمل',
                'cancelled': 'ملغي'
            };
            return statusMap[status] || status;
        }

        function getApplicationTypeText(type) {
            const typeMap = {
                'new': 'تسجيل جديد',
                'renewal': 'تجديد',
                'transfer': 'نقل ملكية',
                'amendment': 'تعديل بيانات',
                'cancellation': 'إلغاء تسجيل'
            };
            return typeMap[type] || type;
        }

        function getCertificateTypeText(type) {
            const typeMap = {
                'registration': 'شهادة تسجيل',
                'safety': 'شهادة سلامة',
                'seaworthiness': 'شهادة صلاحية للإبحار',
                'insurance': 'وثيقة تأمين',
                'inspection': 'شهادة فحص'
            };
            return typeMap[type] || type;
        }
    </script>
</body>
</html>
